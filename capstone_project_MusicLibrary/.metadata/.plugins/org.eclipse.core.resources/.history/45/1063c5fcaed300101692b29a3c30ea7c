<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Manage Songs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{font-family:Inter,system-ui;background:#eef2f7}.card{border-radius:12px}</style>
</head>
<body>
<nav class="navbar navbar-expand bg-white mb-4 shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="admin-dashboard.html">Admin - Songs</a>
    <div class="d-flex">
      <a class="btn btn-sm btn-outline-secondary me-2" href="admin-users.html">Manage Users</a>
      <button id="logout" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
  <div id="alerts"></div>

  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-6"><input id="q" placeholder="Search songs by name, singer, album, director" class="form-control"></div>
      <div class="col-md-6 text-end">
        <button class="btn btn-primary" id="btnAdd">Add Song</button>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <table class="table table-hover align-middle">
      <thead><tr><th>ID</th><th>Name</th><th>Singer</th><th>Album</th><th>Director</th><th>Visible</th><th>Actions</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="songModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="songForm">
        <div class="modal-header">
          <h5 class="modal-title" id="songTitle">Add Song</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="songId">
          <div class="row g-2">
            <div class="col-md-6"><label>Name</label><input id="name" class="form-control" required></div>
            <div class="col-md-6"><label>Singer</label><input id="singer" class="form-control"></div>
            <div class="col-md-6"><label>Album</label><input id="album" class="form-control"></div>
            <div class="col-md-6"><label>Music Director</label><input id="director" class="form-control"></div>
            <div class="col-md-6"><label>Release Date</label><input id="release" type="date" class="form-control"></div>
            <div class="col-md-6"><label>Visible</label><select id="visible" class="form-select"><option value="true">Visible</option><option value="false">Hidden</option></select></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary">Save</button></div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "http://localhost:9000";
const rows = document.getElementById('rows');
const songModal = new bootstrap.Modal(document.getElementById('songModal'));
const songForm = document.getElementById('songForm');

async function load(q='') {
  try {
    const url = q ? `${API}/songs/search?q=${encodeURIComponent(q)}` : `${API}/songs`;
    const data = await (await fetch(url)).json();
    rows.innerHTML = data.map(s => `
      <tr>
        <td>${s.id}</td>
        <td>${s.name}</td>
        <td>${s.singer||''}</td>
        <td>${s.albumName||''}</td>
        <td>${s.musicDirector||''}</td>
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" ${s.visible ? 'checked':''} onchange="toggleVisibility(${s.id}, this.checked)">
          </div>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="edit(${s.id})">Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="del(${s.id})">Delete</button>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    document.getElementById('alerts').innerHTML = `<div class="alert alert-danger">Load failed: ${e.message||e}</div>`;
  }
}

window.toggleVisibility = async (id, visible) => {
  try {
    const url = `${API}/songs/${id}/visibility?visible=${visible}`;
    const res = await fetch(url, { method:'PATCH' });
    if(!res.ok) throw await res.json();
    await load(document.getElementById('q').value);
  } catch(err) {
    alert('Unable to toggle: ' + (err.error || err.message || err));
    load(document.getElementById('q').value);
  }
}

window.edit = async (id) => {
  const s = await (await fetch(`${API}/songs/${id}`)).json();
  document.getElementById('songTitle').innerText = 'Edit Song';
  document.getElementById('songId').value = s.id;
  document.getElementById('name').value = s.name || '';
  document.getElementById('singer').value = s.singer || '';
  document.getElementById('album').value = s.albumName || '';
  document.getElementById('director').value = s.musicDirector || '';
  document.getElementById('release').value = s.releaseDate ? s.releaseDate.split('T')[0] : '';
  document.getElementById('visible').value = s.visible ? 'true' : 'false';
  songModal.show();
}

window.del = async (id) => {
  if(!confirm('Delete song permanently?')) return;
  await fetch(`${API}/songs/${id}`, { method:'DELETE' });
  load();
}

document.getElementById('btnAdd').addEventListener('click', () => {
  document.getElementById('songTitle').innerText = 'Add Song';
  document.getElementById('songId').value = '';
  document.getElementById('name').value = '';
  document.getElementById('singer').value = '';
  document.getElementById('album').value = '';
  document.getElementById('director').value = '';
  document.getElementById('release').value = '';
  document.getElementById('visible').value = 'true';
  songModal.show();
});

songForm.addEventListener('submit', async e => {
  e.preventDefault();
  const id = document.getElementById('songId').value;
  const body = {
    name: document.getElementById('name').value,
    singer: document.getElementById('singer').value,
    albumName: document.getElementById('album').value,
    musicDirector: document.getElementById('director').value,
    releaseDate: document.getElementById('release').value,
    visible: document.getElementById('visible').value === 'true'
  };
  if(!id) {
    await fetch(API + '/songs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  } else {
    await fetch(API + '/songs/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  }
  songModal.hide(); load(document.getElementById('q').value);
});

document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem('admin'); location.href='admin-login.html';});
document.getElementById('q').addEventListener('input', e => load(e.target.value));
load();
</script>
</body>
</html>
