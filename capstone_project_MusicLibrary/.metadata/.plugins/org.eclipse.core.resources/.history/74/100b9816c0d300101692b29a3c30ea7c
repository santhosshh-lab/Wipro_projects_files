<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Music Library</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{font-family:Inter,system-ui;background:#f7fafc;padding-bottom:90px}</style>
</head>
<body>
<nav class="navbar navbar-expand bg-white mb-4 shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Music Library</a>
    <div>
      <a href="user-playlists.html" class="btn btn-sm btn-outline-primary me-2">My Playlists</a>
      <button id="logout" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
  <div id="msg"></div>
  <div class="card p-3 mb-3">
    <div class="row">
      <div class="col-md-9"><input id="q" class="form-control" placeholder="Search songs... (name, singer)"></div>
      <div class="col-md-3 text-end"><button class="btn btn-primary" id="refresh">Refresh</button></div>
    </div>
  </div>

  <div id="list" class="row g-3"></div>
</div>

<!-- Playlist selection modal -->
<div class="modal fade" id="playlistModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5>Select Playlist</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="playlistList">Loading...</div>
    </div>
  </div>
</div>

<!-- bottom audio player -->
<div id="playerBar" style="position:fixed;left:0;right:0;bottom:0;background:#111;color:#fff;padding:10px;display:flex;align-items:center;gap:12px">
  <div style="flex:1">
    <div id="playerTitle">No song</div>
    <div id="playerMeta" class="small text-muted">‚Äî</div>
  </div>
  <div>
    <button id="prevBtn" class="btn btn-sm btn-light">‚èÆ</button>
    <button id="playBtn" class="btn btn-sm btn-primary">‚ñ∂</button>
    <button id="nextBtn" class="btn btn-sm btn-light">‚è≠</button>
    <button id="shuffleBtn" class="btn btn-sm btn-warning">üîÄ</button>
  </div>
  <input id="seek" type="range" min="0" max="100" value="0" style="width:300px">
</div>
<audio id="audio" style="display:none"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "http://localhost:9000";
const listEl = document.getElementById('list');
const user = JSON.parse(localStorage.getItem('user')||'{}');

function ensureArray(x){ return Array.isArray(x) ? x : []; }

async function load(q='') {
  try {
    const url = q ? `${API}/songs/search?q=${encodeURIComponent(q)}` : `${API}/songs`;
    const res = await fetch(url);
    if(!res.ok) throw await res.json().catch(()=>({ message:res.statusText }));
    const data = await res.json();
    const arr = ensureArray(data);
    listEl.innerHTML = arr.map(s => `
      <div class="col-md-4">
        <div class="card p-3 h-100">
          <h5>${s.name}</h5>
          <div class="text-muted small">${s.singer||''} ‚Ä¢ ${s.albumName||''}</div>
          <p class="mt-2">${s.musicDirector ? 'MD: '+s.musicDirector : ''}</p>
          <div class="mt-auto d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary" onclick="viewSong(${s.id})">View</button>
            <div>
              <button class="btn btn-sm btn-success" onclick="openPlaylistModal(${s.id})">Add to Playlist</button>
              <button class="btn btn-sm btn-primary" onclick="quickPlay(${s.id})">Play</button>
            </div>
          </div>
        </div>
      </div>
    `).join('');
    if(arr.length===0) listEl.innerHTML = '<div class="col-12"><div class="card p-3 text-center text-muted">No songs</div></div>';
  } catch(err) {
    document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Unable to load: ${err.message||err.error||err}</div>`;
  }
}

function viewSong(id){ location.href = `user-song-view.html?songId=${id}`; }

// Playlist modal flow
let pendingSongId = null;
async function openPlaylistModal(songId){
  pendingSongId = songId;
  const uid = user.id;
  if(!uid) { alert('Please login'); location.href='user-login.html'; return; }
  const el = document.getElementById('playlistList');
  try {
    const res = await fetch(`${API}/users/${uid}/playlists`);
    if(!res.ok) throw 'Unable to fetch playlists';
    const list = await res.json();
    if(list.length===0) el.innerHTML = '<p class="text-muted">No playlists. Create one in My Playlists.</p>';
    else el.innerHTML = list.map(p => `<div class="d-grid gap-1 mb-2"><button class="btn btn-outline-primary" onclick="addTo(${p.id})">${p.name}</button></div>`).join('');
    new bootstrap.Modal(document.getElementById('playlistModal')).show();
  } catch(e){ el.innerHTML = `<div class="text-danger">Failed to load playlists</div>`; }
}

async function addTo(pid){
  const uid = user.id;
  try {
    const res = await fetch(`${API}/users/${uid}/playlists/${pid}/songs`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ songId: pendingSongId })
    });
    if(!res.ok) throw await res.json().catch(()=>({ message: res.statusText }));
    alert('Added to playlist');
    bootstrap.Modal.getInstance(document.getElementById('playlistModal')).hide();
  } catch(e){ alert('Failed: ' + (e.message||e.error||e)); }
}

// Quick play uses bottom player
const audio = document.getElementById('audio');
const playerTitle = document.getElementById('playerTitle');
const playerMeta = document.getElementById('playerMeta');
const playBtn = document.getElementById('playBtn');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const seek = document.getElementById('seek');

let playQueue = [];
let currentIndex = 0;
let shuffleOn = false;

async function quickPlay(songId){
  try {
    const res = await fetch(`${API}/songs/${songId}`);
    if(!res.ok) throw 'Song not found';
    const s = await res.json();
    playQueue = [s];
    currentIndex = 0;
    startPlaying();
  } catch(e){ alert('Play failed'); }
}

function startPlaying(){
  const s = playQueue[currentIndex];
  if(!s) return;
  audio.src = s.fileUrl || "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars3.wav";
  playerTitle.innerText = s.name;
  playerMeta.innerText = s.singer || '';
  audio.play();
  playBtn.innerText = '‚è∏';
}

playBtn.addEventListener('click', ()=>{
  if(audio.paused) { audio.play(); playBtn.innerText='‚è∏'; } else { audio.pause(); playBtn.innerText='‚ñ∂'; }
});

nextBtn.addEventListener('click', ()=>{
  if(shuffleOn) {
    currentIndex = Math.floor(Math.random()*playQueue.length);
  } else {
    currentIndex = (currentIndex + 1) % playQueue.length;
  }
  startPlaying();
});
prevBtn.addEventListener('click', ()=>{
  currentIndex = (currentIndex - 1 + playQueue.length) % playQueue.length;
  startPlaying();
});
shuffleBtn.addEventListener('click', ()=>{ shuffleOn = !shuffleOn; shuffleBtn.style.opacity = shuffleOn?1:0.6; });

audio.addEventListener('timeupdate', ()=> {
  if(audio.duration) seek.value = Math.floor((audio.currentTime / audio.duration) * 100);
});
seek.addEventListener('input', ()=> {
  if(audio.duration) audio.currentTime = (seek.value/100)*audio.duration;
});
audio.addEventListener('ended', ()=> {
  if(shuffleOn) currentIndex = Math.floor(Math.random()*playQueue.length);
  else currentIndex = (currentIndex + 1) % playQueue.length;
  startPlaying();
});

// Logout + events
document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='user-login.html';});
document.getElementById('q').addEventListener('input', e=> load(e.target.value));
document.getElementById('refresh').addEventListener('click', ()=> load());
load();
</script>
</body>
</html>
