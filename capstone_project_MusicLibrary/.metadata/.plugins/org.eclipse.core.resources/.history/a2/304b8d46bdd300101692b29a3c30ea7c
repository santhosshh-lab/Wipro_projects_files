<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Songs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{font-family:Inter,system-ui;background:#f8fafc}.card{border-radius:12px}</style>
</head>
<body>
<nav class="navbar navbar-expand bg-white mb-4 shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Music Library</a>
    <div>
      <a href="user-playlists.html" class="btn btn-sm btn-outline-primary me-2">My Playlists</a>
      <button id="logout" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
  <div id="msg"></div>
  <div class="card p-3 mb-3">
    <div class="row">
      <div class="col-md-9"><input id="q" class="form-control" placeholder="Search songs... (name, singer)"></div>
      <div class="col-md-3 text-end"><button class="btn btn-primary" id="refresh">Refresh</button></div>
    </div>
  </div>

  <div id="list" class="row g-3"></div>
</div>

<script>
const API = "http://localhost:9000";
const list = document.getElementById('list');
const userObj = JSON.parse(localStorage.getItem('user') || '{}');

async function load(q='') {
  try {
    const url = q ? `${API}/songs/search?q=${encodeURIComponent(q)}` : `${API}/songs`;
    const data = await (await fetch(url)).json();
    list.innerHTML = data.map(s => `
      <div class="col-md-4">
        <div class="card p-3 h-100">
          <h5>${s.name}</h5>
          <div class="text-muted small">${s.singer || ''} â€¢ ${s.albumName || ''}</div>
          <p class="mt-2">${s.musicDirector ? 'MD: '+s.musicDirector : ''}</p>
          <div class="mt-auto d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary" onclick="view(${s.id})">View</button>
            <button class="btn btn-sm btn-success" onclick="addToPlaylist(${s.id})">Add to Playlist</button>
          </div>
        </div>
      </div>
    `).join('');
  } catch(e) { document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Unable to load: ${e.message||e}</div>`; }
}

function view(id) { window.location.href = 'user-profile.html?songId='+id; }

async function addToPlaylist(songId) {
  const uid = userObj.id;
  if(!uid) return alert('Please login first');
  // simple prompt to choose playlist id
  const pid = prompt('Enter playlist id (create one in My Playlists if none):');
  if(!pid) return;
  try {
    const res = await fetch(`${API}/users/${uid}/playlists/${pid}/songs`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ songId }) });
    if(!res.ok) throw await res.json();
    alert('Added to playlist');
  } catch(e) { alert('Failed: ' + (e.error||e.message||e)); }
}

document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='user-login.html';});
document.getElementById('q').addEventListener('input', e => load(e.target.value));
document.getElementById('refresh').addEventListener('click', ()=> load());
load();
</script>
</body>
</html>
