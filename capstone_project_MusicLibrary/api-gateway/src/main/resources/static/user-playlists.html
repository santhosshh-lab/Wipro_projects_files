<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>My Playlists</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{font-family:Inter,system-ui;background:#f7fafc;padding-bottom:90px}</style>
</head>
<body>
<nav class="navbar navbar-expand bg-white mb-4 shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">üéµ My Playlists</a>
    <div>
      <button id="logout" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
  <div id="msg"></div>
  <div class="card p-3 mb-3">
    <div class="d-flex gap-2">
      <input id="name" class="form-control" placeholder="Enter playlist name">
      <button class="btn btn-primary" id="createBtn">Create</button>
    </div>
  </div>

  <div id="wrap"></div>
</div>

<!-- small bottom player -->
<div id="playerBar" style="position:fixed;left:0;right:0;bottom:0;background:#111;color:#fff;padding:10px;display:flex;align-items:center;gap:12px">
  <div style="flex:1">
    <div id="playerTitle">No song</div>
  </div>
  <div>
    <button id="playBtn" class="btn btn-sm btn-primary">‚ñ∂</button>
    <button id="shuffleBtn" class="btn btn-sm btn-warning">üîÄ</button>
  </div>
</div>
<audio id="audio" style="display:none"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "http://localhost:9000";
const user = JSON.parse(localStorage.getItem('user')||'{}');
if(!user.id){ alert('Login required'); location.href='user-login.html'; }

const wrap = document.getElementById('wrap');
const audio = document.getElementById('audio');
const playerTitle = document.getElementById('playerTitle');
const playBtn = document.getElementById('playBtn');
const shuffleBtn = document.getElementById('shuffleBtn');

let currentPlaylist = [];
let currentIndex = 0;
let shuffleOn = false;

async function loadPlaylists(){
  const res = await fetch(`${API}/users/${user.id}/playlists`);
  const list = await res.json();
  wrap.innerHTML = list.map(p => `
    <div class="card p-3 mb-2 d-flex justify-content-between align-items-center">
      <div><strong>${p.name}</strong></div>
      <div>
        <button class="btn btn-sm btn-outline-primary" onclick="openPlaylist(${p.id},'${p.name}')">Open</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deletePlaylist(${p.id})">Delete</button>
      </div>
    </div>
  `).join('');
  if(list.length===0) wrap.innerHTML = '<div class="card p-3 text-center text-muted">No playlists</div>';
}

document.getElementById('createBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('name').value.trim();
  if(!name) return alert('Enter name');
  await fetch(`${API}/users/${user.id}/playlists`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name })});
  document.getElementById('name').value='';
  loadPlaylists();
});

async function deletePlaylist(id){
  if(!confirm('Delete playlist?')) return;
  await fetch(`${API}/users/${user.id}/playlists/${id}`, { method:'DELETE' });
  loadPlaylists();
}

// open playlist in a new window like earlier but we will render in same window
async function openPlaylist(id, name){
  const res = await fetch(`${API}/users/${user.id}/playlists/${id}/songs`);
  const songs = await res.json();
  currentPlaylist = songs;
  currentIndex = 0;
  renderPlaylistView(id, name, songs);
}

function renderPlaylistView(pid, pname, songs){
	  document.body.scrollTop = 0;
	  window.scrollTo(0,0);

	  wrap.innerHTML = `
	    <div class="mb-3">
	      <a href="user-playlists.html" class="btn btn-sm btn-outline-secondary">‚Üê Back</a>
	    </div>

	    <h4>${pname}</h4>

	    <div id="songList">
	      ${
	        songs.length > 0
	        ? songs.map((s, i) => `
	            <div class="card p-3 mb-2">
	              <div class="d-flex justify-content-between align-items-center">
	                <div>
	                  <div><strong>${s.name}</strong></div>
	                  <div class="text-muted small">${s.singer || ''}</div>
	                </div>
	                <div>
	                  <button class="btn btn-sm btn-primary" onclick="playFromPlaylist(${i})">Play</button>
	                  <button class="btn btn-sm btn-danger" onclick="removeFromPlaylist(${pid}, ${s.id})">Remove</button>
	                </div>
	              </div>
	            </div>
	          `).join('')
	        : `<div class="card p-3 text-muted">No songs</div>`
	      }
	    </div>
	  `;
	}

async function removeFromPlaylist(pid, songId){
  await fetch(`${API}/users/${user.id}/playlists/${pid}/songs/${songId}`, { method:'DELETE' });
  openPlaylist(pid);
}

function playFromPlaylist(i){
  if(!currentPlaylist.length) return;
  currentIndex = i;
  const s = currentPlaylist[currentIndex];
  audio.src = s.fileUrl || "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars3.wav";
  playerTitle.innerText = s.name;
  audio.play();
  playBtn.innerText = '‚è∏';
}

playBtn.addEventListener('click', ()=>{
  if(audio.paused){ audio.play(); playBtn.innerText='‚è∏'; } else { audio.pause(); playBtn.innerText='‚ñ∂'; }
});
shuffleBtn.addEventListener('click', ()=>{
  shuffleOn = !shuffleOn; shuffleBtn.style.opacity = shuffleOn?1:0.6;
  if(shuffleOn && currentPlaylist.length) {
    currentPlaylist = currentPlaylist.sort(()=>Math.random()-0.5);
    playFromPlaylist(0);
  }
});
audio.addEventListener('ended', ()=>{
  if(shuffleOn) {
    const idx = Math.floor(Math.random()*currentPlaylist.length);
    playFromPlaylist(idx);
  } else {
    currentIndex = (currentIndex + 1) % currentPlaylist.length;
    playFromPlaylist(currentIndex);
  }
});

document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href='user-login.html';});
loadPlaylists();
</script>
</body>
</html>
