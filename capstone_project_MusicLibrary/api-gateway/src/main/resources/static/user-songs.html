<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Music Library</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui; background:#f7fafc; padding-bottom:90px }
  </style>
</head>

<body>
<!-- NAVBAR -->
<nav class="navbar navbar-expand bg-white mb-4 shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Music Library</a>
    <div>
      <a href="user-playlists.html" class="btn btn-sm btn-outline-primary me-2">My Playlists</a>
      <button id="logout" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>
</nav>

<!-- SEARCH + LIST -->
<div class="container">
  <div id="msg"></div>

  <div class="card p-3 mb-3">
    <div class="row">
      <div class="col-md-9">
        <input id="q" class="form-control" placeholder="Search songs (name, singer)">
      </div>
      <div class="col-md-3 text-end">
        <button class="btn btn-primary" id="refresh">Refresh</button>
      </div>
    </div>
  </div>

  <div id="list" class="row g-3"></div>
</div>

<!-- PLAYLIST SELECT MODAL -->
<div class="modal fade" id="playlistModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Select Playlist</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="playlistList">Loading...</div>
    </div>
  </div>
</div>

<!-- BOTTOM PLAYER -->
<div id="playerBar" 
     style="position:fixed;left:0;right:0;bottom:0;background:#111;color:#fff;padding:10px;
            display:flex;align-items:center;gap:12px">
  
  <div style="flex:1">
    <div id="playerTitle">No song</div>
    <div id="playerMeta" class="small text-muted">‚Äî</div>
  </div>

  <div>
    <button id="prevBtn" class="btn btn-sm btn-light">‚èÆ</button>
    <button id="playBtn" class="btn btn-sm btn-primary">‚ñ∂</button>
    <button id="nextBtn" class="btn btn-sm btn-light">‚è≠</button>
    <button id="shuffleBtn" class="btn btn-sm btn-warning">üîÄ</button>
  </div>

  <input id="seek" type="range" min="0" max="100" value="0" style="width:300px">
</div>

<audio id="audio" style="display:none"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
// ======================
// GLOBAL SETUP
// ======================
const API = "http://localhost:9000";
const listEl = document.getElementById('list');
const user = JSON.parse(localStorage.getItem('user') || '{}');
if (!user.id) { alert("Login required"); location.href="user-login.html"; }

function ensureArray(x){ return Array.isArray(x) ? x : []; }


// ======================
// LOAD SONGS ‚Üí ONLY VISIBLE
// ======================
async function load(q = '') {
  try {
    const url = q
      ? `${API}/songs/search-visible?q=${encodeURIComponent(q)}`
      : `${API}/songs/visible`;

    const res = await fetch(url);
    if (!res.ok) throw await res.json().catch(()=>({message:res.statusText}));

    const data = ensureArray(await res.json());

    listEl.innerHTML = data.map(s => `
      <div class="col-md-4">
        <div class="card p-3 h-100">
          <h5>${s.name}</h5>
          <div class="text-muted small">${s.singer || ''} ‚Ä¢ ${s.albumName || ''}</div>
          <p class="mt-2">${s.musicDirector ? 'MD: ' + s.musicDirector : ''}</p>

          <div class="mt-auto d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary" onclick="viewSong(${s.id})">View</button>

            <div>
              <button class="btn btn-sm btn-success" onclick="openPlaylistModal(${s.id})">Add</button>
              <button class="btn btn-sm btn-primary" onclick="quickPlay(${s.id})">Play</button>
            </div>
          </div>
        </div>
      </div>
    `).join('');

    if (data.length === 0)
      listEl.innerHTML = `<div class="col-12"><div class="card p-3 text-center text-muted">No songs found</div></div>`;

  } catch(e) {
    document.getElementById('msg').innerHTML =
      `<div class="alert alert-danger">Unable to load songs: ${e.message || e}</div>`;
  }
}


// ======================
// VIEW SONG PAGE
// ======================
function viewSong(id){
  location.href = `user-song-view.html?songId=${id}`;
}


// ======================
// ADD TO PLAYLIST ‚Äî MODAL
// ======================
let pendingSongId = null;

async function openPlaylistModal(songId){
  pendingSongId = songId;

  const uid = user.id;
  const box = document.getElementById('playlistList');

  const res = await fetch(`${API}/users/${uid}/playlists`);
  const playlists = await res.json();

  if (!playlists.length){
    box.innerHTML = `<p class="text-muted">No playlists. Create one in My Playlists.</p>`;
  } else {
    box.innerHTML = playlists.map(p =>
      `<button class="btn btn-outline-primary w-100 mb-2" onclick="addToPlaylist(${p.id})">${p.name}</button>`
    ).join('');
  }

  new bootstrap.Modal(document.getElementById("playlistModal")).show();
}

async function addToPlaylist(pid){
  const uid = user.id;

  await fetch(`${API}/users/${uid}/playlists/${pid}/songs`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ songId: pendingSongId })
  });

  alert("Added to playlist!");
  bootstrap.Modal.getInstance(document.getElementById('playlistModal')).hide();
}


// ======================
// AUDIO PLAYER LOGIC
// ======================
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const playerTitle = document.getElementById('playerTitle');
const playerMeta = document.getElementById('playerMeta');
const seek = document.getElementById('seek');

let playQueue = [];
let currentIndex = 0;
let shuffleOn = false;

async function quickPlay(songId){
  const res = await fetch(`${API}/songs/${songId}`);
  const s = await res.json();

  playQueue = [s];
  currentIndex = 0;
  startPlayback();
}

function startPlayback(){
  const s = playQueue[currentIndex];
  audio.src = s.fileUrl || "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars3.wav";
  playerTitle.textContent = s.name;
  playerMeta.textContent = s.singer || "-";
  audio.play();
  playBtn.textContent = "‚è∏";
}

playBtn.addEventListener("click", ()=>{
  if(audio.paused){ audio.play(); playBtn.textContent="‚è∏"; }
  else { audio.pause(); playBtn.textContent="‚ñ∂"; }
});

nextBtn.addEventListener("click", ()=>{
  currentIndex = shuffleOn
    ? Math.floor(Math.random()*playQueue.length)
    : (currentIndex + 1) % playQueue.length;

  startPlayback();
});

prevBtn.addEventListener("click", ()=>{
  currentIndex = (currentIndex - 1 + playQueue.length) % playQueue.length;
  startPlayback();
});

shuffleBtn.addEventListener("click", ()=>{
  shuffleOn = !shuffleOn;
  shuffleBtn.style.opacity = shuffleOn ? 1 : 0.5;
});

audio.addEventListener("timeupdate", ()=>{
  if(audio.duration) seek.value = (audio.currentTime / audio.duration) * 100;
});

seek.addEventListener("input", ()=>{
  if(audio.duration) audio.currentTime = (seek.value/100) * audio.duration;
});

audio.addEventListener("ended", ()=>{
  nextBtn.click();
});


// ======================
// EVENTS
// ======================
document.getElementById("logout").addEventListener("click", ()=>{
  localStorage.removeItem("user");
  location.href = "user-login.html";
});

document.getElementById("q").addEventListener("input", e => load(e.target.value));
document.getElementById("refresh").addEventListener("click", load);

load();
</script>

</body>
</html>
